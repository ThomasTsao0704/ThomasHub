name: Build Apps & Update Hub

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  build-and-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (for apps that need build)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install helpers (jq, python3)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3

      - name: Build each app into /apps/<app>/site
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          for APPDIR in apps/*/ ; do
            APPNAME=$(basename "$APPDIR")
            echo ">>> Processing app: $APPNAME"

            SRC="$APPDIR/src"
            SITE="$APPDIR/site"
            PKG="$APPDIR/package.json"

            rm -rf "$SITE"
            mkdir -p "$SITE"

            if [[ -f "$PKG" ]] && jq -e '.scripts.build' "$PKG" >/dev/null 2>&1; then
              echo "    - Found build script. Building..."
              pushd "$APPDIR" >/dev/null
              npm ci
              npm run build
              popd >/dev/null

              OUT=""
              for CAND in dist out build; do
                if [[ -d "$APPDIR/$CAND" ]]; then OUT="$APPDIR/$CAND"; break; fi
              done
              [[ -z "$OUT" ]] && OUT="$SRC"
              cp -r "$OUT"/. "$SITE"/
            else
              echo "    - No build step. Copying /src -> /site"
              [[ -d "$SRC" ]] && cp -r "$SRC"/. "$SITE"/ || true
            fi

            # ensure linkable (NO HEREDOC: use printf to avoid YAML parse issues)
            if [[ ! -f "$SITE/index.html" ]]; then
              printf '%s\n' \
                '<!doctype html><meta charset="utf-8"><title>'"$APPNAME"'</title>' \
                '<h1>'"$APPNAME"'</h1><p>No index.html found. Placeholder generated by workflow.</p>' \
                > "$SITE/index.html"
            fi
          done

      - name: Regenerate Hub index.html (preserve brand frame)
        shell: bash
        run: |
          set -euo pipefail

          # Build list of app links
          LIST_ITEMS=""
          shopt -s nullglob
          for SITEIDX in apps/*/site/index.html ; do
            APPNAME=$(basename "$(dirname "$SITEIDX")")
            PREVIEW="/apps/${APPNAME}/site/"
            SOURCE="https://github.com/${GITHUB_REPOSITORY}/tree/main/apps/${APPNAME}"
            ITEM="<li><a href=\"${PREVIEW}\" target=\"_blank\">${APPNAME} 預覽</a> · <a href=\"${SOURCE}\" target=\"_blank\">原始碼</a></li>"
            LIST_ITEMS="${LIST_ITEMS}\n        ${ITEM}"
          done

          # If no apps, fallback hint
          if [[ -z "$LIST_ITEMS" ]]; then
            LIST_ITEMS="\n        <li>尚無可列出 App;請在 <code>apps/&lt;app&gt;/src</code> 放入內容或加入打包流程。</li>"
          fi

          # Write list to a file to avoid quoting problems
          printf "%b" "$LIST_ITEMS" > list.html

          # Safely replace first <ul>...</ul> and "Updated:" via Python (no sed)
          python3 - <<'PY'
          import re, datetime
          from pathlib import Path

          idx = Path("index.html")
          html = idx.read_text(encoding="utf-8")

          lst = Path("list.html").read_text(encoding="utf-8")

          # replace only the FIRST <ul>...</ul>
          html = re.sub(r"<ul>.*?</ul>", "<ul>\n" + lst + "\n      </ul>", html, count=1, flags=re.S)

          # update the FIRST "Updated:" occurrence
          html = re.sub(r"Updated:[^<]*", "Updated: " + datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC"), html, count=1)

          idx.write_text(html, encoding="utf-8")
          PY

      - name: Commit & push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: build apps and update hub list"
          file_pattern: |
            apps/**/site/**
            index.html

      - name: Trigger GitHub Pages rebuild
        if: always()
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/pages/builds" > /dev/null

      - name: Wait for Pages to deploy (max ~150s)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for i in $(seq 1 30); do
            STATUS=$(curl -s \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/pages/builds/latest" \
              | jq -r '.status // "unknown"')
            echo "Attempt $i: status=$STATUS"
            if [[ "$STATUS" == "built" ]]; then
              echo "Pages is built and live."
              exit 0
            fi
            sleep 5
          done
          echo "Timeout waiting for Pages (will still go live shortly)."
