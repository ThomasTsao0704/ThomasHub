name: Build Apps & Update Hub

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  build-and-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install helpers
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Build each app into /apps/<app>/site
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          for APPDIR in apps/*/ ; do
            APPNAME=$(basename "$APPDIR")
            SRC="$APPDIR/src"
            SITE="$APPDIR/site"
            PKG="$APPDIR/package.json"

            rm -rf "$SITE"
            mkdir -p "$SITE"

            if [[ -f "$PKG" ]] && jq -e '.scripts.build' "$PKG" >/dev/null 2>&1; then
              echo "==> Building $APPNAME"

              pushd "$APPDIR" >/dev/null

              # ---- Package manager detection ----
              if [[ -f pnpm-lock.yaml ]]; then
                corepack enable pnpm >/dev/null 2>&1 || true
                pnpm install --frozen-lockfile || pnpm install
                BUILD_CMD="pnpm run build"
              elif [[ -f yarn.lock ]]; then
                corepack enable yarn >/dev/null 2>&1 || true
                yarn install --frozen-lockfile || yarn install
                BUILD_CMD="yarn build"
              else
                if [[ -f package-lock.json ]]; then
                  npm ci
                else
                  npm install
                fi
                BUILD_CMD="npm run build"
              fi

              # ---- Run build ----
              bash -lc "$BUILD_CMD"

              popd >/dev/null

              # ---- Pick output folder or fallback to src ----
              OUT=""
              for CAND in dist out build; do
                if [[ -d "$APPDIR/$CAND" ]]; then OUT="$APPDIR/$CAND"; break; fi
              done
              [[ -z "$OUT" ]] && OUT="$SRC"
              [[ -d "$OUT" ]] && cp -r "$OUT"/. "$SITE"/

            else
              echo "==> $APPNAME has no build script; copying src to site"
              [[ -d "$SRC" ]] && cp -r "$SRC"/. "$SITE"/ || true
            fi

            # ensure linkable (ASCII only, single line)
            if [[ ! -f "$SITE/index.html" ]]; then
              echo '<!doctype html><meta charset="utf-8"><title>'"$APPNAME"'</title><h1>'"$APPNAME"'</h1><p>No index.html found. Placeholder.</p>' > "$SITE/index.html"
            fi
          done

      - name: Recreate Hub index.html (simple and robust)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          LIST_ITEMS=""
          for SITEIDX in apps/*/site/index.html ; do
            APPNAME=$(basename "$(dirname "$SITEIDX")")
            PREVIEW="/apps/${APPNAME}/site/"
            SOURCE="https://github.com/${GITHUB_REPOSITORY}/tree/main/apps/${APPNAME}"
            ITEM="<li><a href=\"${PREVIEW}\" target=\"_blank\">${APPNAME} Preview</a> Â· <a href=\"${SOURCE}\" target=\"_blank\">Source</a></li>"
            LIST_ITEMS="${LIST_ITEMS}\n            ${ITEM}"
          done

          if [[ -z "$LIST_ITEMS" ]]; then
            LIST_ITEMS="\n            <li>No apps yet. Put files in apps/&lt;app&gt;/src or add a build step.</li>"
          fi

          UPDATED="$(date -u +"%Y-%m-%d %H:%M UTC")"

          {
            echo '<!DOCTYPE html>'
            echo '<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">'
            echo '<title>ThomasHub</title>'
            echo '<style>'
            echo 'body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#f5f3f0;color:#2f2f2f}'
            echo 'header{background:linear-gradient(90deg,#d4af37,#7C9B7A);color:#fff;text-align:center;padding:32px 12px}'
            echo 'main{max-width:900px;margin:24px auto;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:20px}'
            echo 'h1{margin:0} h2{color:#7C9B7A;border-left:5px solid #d4af37;padding-left:8px}'
            echo 'ul{list-style:none;margin:0;padding-left:8px;line-height:1.8}'
            echo 'a{color:#7C9B7A;text-decoration:none;font-weight:600}'
            echo 'a:hover{color:#d4af37;text-decoration:underline}'
            echo '.meta{margin-top:12px;color:#666;font-size:14px;text-align:right}'
            echo 'footer{margin:16px auto 28px;text-align:center;color:#666}'
            echo '</style></head><body>'
            echo '<header><h1>ThomasHub</h1><p>Data-driven & warm</p></header>'
            echo '<main><h2>Apps</h2><ul>'
            printf "%b\n" "$LIST_ITEMS"
            echo '        </ul>'
            echo '  <div class="meta">Updated: '"$UPDATED"'</div>'
            echo '</main><footer>&copy; 2025 Thomas</footer></body></html>'
          } > index.html

      - name: Commit & push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: build apps and regenerate hub"
          file_pattern: |
            apps/**/site/**
            index.html

      - name: Trigger GitHub Pages rebuild
        if: always()
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/pages/builds" > /dev/null

      - name: Wait for Pages to deploy (max ~150s)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for i in $(seq 1 30); do
            STATUS=$(curl -s \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/pages/builds/latest" \
              | jq -r '.status // "unknown"')
            echo "Attempt $i: status=$STATUS"
            if [[ "$STATUS" == "built" ]]; then
              echo "Pages is built and live."
              exit 0
            fi
            sleep 5
          done
          echo "Timeout waiting for Pages (will still go live shortly)."
