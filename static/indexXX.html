<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>å°è‚¡åˆ†æç³»çµ± - æ•´åˆç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- ç¬¬ä¸‰æ–¹å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .status-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
        }

        .status-indicator.online {
            background: rgba(76, 175, 80, 0.3);
            color: #a5d6a7;
        }

        .status-indicator.offline {
            background: rgba(244, 67, 54, 0.3);
            color: #ef9a9a;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 220px;
            background: #f5f5f5;
            padding: 20px;
            border-right: 1px solid #e0e0e0;
        }

        .nav-btn {
            display: block;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: none;
            background: white;
            color: #333;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
        }

        .nav-btn:hover {
            background: #e3f2fd;
            transform: translateX(4px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 500;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: transform 0.2s;
            margin-right: 10px;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
        }

        #stockInfo, #statsContainer, #dataTable,
        #analysisResults, #dailyResults, #compareResults {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
        }

        .error {
            color: #d32f2f;
            padding: 15px;
            background: #ffebee;
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
        }

        /* åˆ†æè¨˜éŒ„ç›¸é—œæ¨£å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .tags-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            min-height: 45px;
            background: white;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            font-size: 13px;
        }

        .tag-item .remove-tag {
            cursor: pointer;
            font-weight: bold;
            margin-left: 3px;
        }

        .tags-input-container input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 120px;
            padding: 5px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-card h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }

        .stat-card .sub-value {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .record-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            margin-bottom: 15px;
        }

        .record-card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .record-card p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .outcome-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .outcome-win {
            background: #d4edda;
            color: #155724;
        }

        .outcome-loss {
            background: #f8d7da;
            color: #721c24;
        }

        .outcome-holding {
            background: #d1ecf1;
            color: #0c5460;
        }

        .outcome-pending {
            background: #fff3cd;
            color: #856404;
        }

        .helper-text {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .strategy-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .strategy-table th,
        .strategy-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .strategy-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .strategy-table tr:hover {
            background: #f5f5f5;
        }

        .app-footer {
            background: #f5f5f5;
            padding: 20px;
            text-align: center;
            color: #666;
            border-top: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .nav-btn {
                display: inline-block;
                width: auto;
                margin-right: 8px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="app-header">
        <h1>ğŸ“ˆ å°è‚¡åˆ†æç³»çµ± - æ•´åˆç‰ˆ</h1>
        <span id="apiStatus" class="status-indicator"></span>
    </header>

    <main class="main-content">
        <aside class="sidebar">
            <button data-view="stock" class="nav-btn active">ğŸ“Š è‚¡ç¥¨æŸ¥è©¢</button>
            <button data-view="analysis" class="nav-btn">ğŸ“‰ å€é–“åˆ†æ</button>
            <button data-view="daily" class="nav-btn">ğŸ“… æ¯æ—¥è¡Œæƒ…</button>
            <button data-view="compare" class="nav-btn">âš–ï¸ è‚¡ç¥¨æ¯”è¼ƒ</button>
            <button data-view="record" class="nav-btn">ğŸ“ æ–°å¢è¨˜éŒ„</button>
            <button data-view="browse" class="nav-btn">ğŸ“š ç€è¦½çµ±è¨ˆ</button>
        </aside>

        <section class="content-area">

            <!-- è‚¡ç¥¨æŸ¥è©¢è¦–åœ– -->
            <section id="stockView" class="view-section active">
                <h2>ğŸ“Š è‚¡ç¥¨æŸ¥è©¢</h2>
                <div class="input-group">
                    <input id="stockCode" type="text" placeholder="è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ (ä¾‹: 2330)" />
                    <button id="btnLoadStock" class="btn-primary">æŸ¥è©¢</button>
                </div>
                
                <div id="stockInfo"></div>
                <div id="statsContainer"></div>
                <div id="dataTable"></div>
            </section>

            <!-- å€é–“åˆ†æè¦–åœ– -->
            <section id="analysisView" class="view-section">
                <h2>ğŸ“‰ å€é–“åˆ†æ</h2>
                <div class="input-group">
                    <input id="analysisCode" type="text" placeholder="è‚¡ç¥¨ä»£ç¢¼ (ä¾‹: 2330)" />
                    <input id="startDate" type="text" placeholder="èµ·å§‹æ—¥æœŸ (ä¾‹: 20240101)" />
                    <input id="endDate" type="text" placeholder="çµæŸæ—¥æœŸ (ä¾‹: 20241231)" />
                    <button id="btnRange" class="btn-primary">åˆ†æ</button>
                </div>
                <div id="analysisResults"></div>
            </section>

            <!-- æ¯æ—¥è¡Œæƒ…è¦–åœ– -->
            <section id="dailyView" class="view-section">
                <h2>ğŸ“… æ¯æ—¥è¡Œæƒ…</h2>
                <div class="input-group">
                    <input id="dailyDate" type="text" placeholder="æ—¥æœŸ (ä¾‹: 20241213)" />
                    <button id="btnDaily" class="btn-primary">æŸ¥è©¢</button>
                </div>
                <div id="dailyResults"></div>
            </section>

            <!-- è‚¡ç¥¨æ¯”è¼ƒè¦–åœ– -->
            <section id="compareView" class="view-section">
                <h2>âš–ï¸ è‚¡ç¥¨æ¯”è¼ƒ</h2>
                <div class="input-group">
                    <input id="compareCodes" type="text" placeholder="å¤šæª”è‚¡ç¥¨ä»£ç¢¼,é€—è™Ÿåˆ†éš” (ä¾‹: 2330,2317,2454)" />
                    <button id="btnCompare" class="btn-primary">æ¯”è¼ƒ</button>
                </div>
                <div id="compareResults"></div>
            </section>

            <!-- æ–°å¢åˆ†æè¨˜éŒ„è¦–åœ– -->
            <section id="recordView" class="view-section">
                <h2>ğŸ“ æ–°å¢è‚¡ç¥¨åˆ†æç´€éŒ„</h2>
                <form id="recordForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>åˆ†ææ—¥æœŸ <span style="color: red;">*</span></label>
                            <input type="date" id="recordDate" required>
                        </div>
                        <div class="form-group">
                            <label>è‚¡ç¥¨ä»£è™Ÿ <span style="color: red;">*</span></label>
                            <input type="text" id="recordStockCode" placeholder="ä¾‹: 2330" required>
                        </div>
                        <div class="form-group">
                            <label>è‚¡ç¥¨åç¨±</label>
                            <input type="text" id="recordStockName" placeholder="ä¾‹: å°ç©é›»">
                        </div>
                        <div class="form-group">
                            <label>ä¿¡å¿ƒåº¦ (1-10)</label>
                            <input type="range" id="recordConfidence" min="1" max="10" value="5"
                                oninput="document.getElementById('confidenceValue').textContent = this.value">
                            <span id="confidenceValue">5</span>/10
                        </div>
                        <div class="form-group">
                            <label>ç›®æ¨™åƒ¹</label>
                            <input type="number" id="recordTargetPrice" step="0.01" placeholder="é æœŸé”åˆ°çš„åƒ¹æ ¼">
                        </div>
                        <div class="form-group">
                            <label>åœæåƒ¹</label>
                            <input type="number" id="recordStopLoss" step="0.01" placeholder="é¢¨éšªæ§åˆ¶åƒ¹ä½">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ç­–ç•¥æ¨™ç±¤
                            <span class="helper-text">(æŒ‰ Enter æ–°å¢æ¨™ç±¤,å¦‚:ç•¶æ²–ã€æ³¢æ®µã€å­£å ±å‰ã€æŠ€è¡“çªç ´)</span>
                        </label>
                        <div class="tags-input-container" id="tagsContainer">
                            <input type="text" id="tagsInput" placeholder="è¼¸å…¥æ¨™ç±¤å¾ŒæŒ‰ Enter">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é åˆ¤æ–¹å‘ <span style="color: red;">*</span></label>
                        <select id="recordDirection" required>
                            <option value="">è«‹é¸æ“‡æ–¹å‘</option>
                            <option value="å¤š">å¤š</option>
                            <option value="-">-</option>
                            <option value="ç©º">ç©º</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>é€²å ´ç†ç”± <span style="color: red;">*</span></label>
                        <textarea id="recordReason" placeholder="ç°¡è¿°é€²å ´ç†ç”±ï¼Œä¾‹: å‡ç·šé»ƒé‡‘äº¤å‰ã€çªç ´å‰é«˜..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>æŠ€è¡“åˆ†æ</label>
                        <textarea id="recordAnalysis" placeholder="è©³ç´°æŠ€è¡“åˆ†æ..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>é¡å¤–ç­†è¨˜</label>
                        <textarea id="recordNotes" placeholder="å…¶ä»–è£œå……èªªæ˜..."></textarea>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>æª¢æŸ¥å¤©æ•¸</label>
                            <input type="number" id="checkDays" value="5" min="1" max="30">
                            <span class="helper-text">å›æ¸¬æ™‚æª¢æŸ¥å¹¾å€‹äº¤æ˜“æ—¥å¾Œçš„çµæœ</span>
                        </div>
                        <div class="form-group">
                            <label>çµæœç‹€æ…‹</label>
                            <select id="recordOutcome">
                                <option value="pending">å¾…å›æ¸¬</option>
                                <option value="holding">æŒæœ‰ä¸­</option>
                                <option value="win">å‹</option>
                                <option value="loss">æ•—</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">ğŸ’¾ å„²å­˜è¨˜éŒ„</button>
                </form>
            </section>

            <!-- ç€è¦½çµ±è¨ˆè¦–åœ– -->
            <section id="browseView" class="view-section">
                <h2>ğŸ“š ç€è¦½åˆ†æç´€éŒ„ & çµ±è¨ˆåˆ†æ</h2>

                <div id="statsSection">
                    <h3 style="margin-bottom: 15px;">ğŸ“Š ç¸¾æ•ˆçµ±è¨ˆå„€è¡¨æ¿</h3>
                    <div class="stats-container">
                        <div class="stat-card">
                            <h4>ç¸½é«”å‘½ä¸­ç‡</h4>
                            <div class="value" id="overallWinRate">--%</div>
                            <div class="sub-value" id="overallStats">è¨ˆç®—ä¸­...</div>
                        </div>
                        <div class="stat-card">
                            <h4>é«˜ä¿¡å¿ƒåº¦ (â‰¥8) å‘½ä¸­ç‡</h4>
                            <div class="value" id="highConfWinRate">--%</div>
                            <div class="sub-value" id="highConfStats">è¨ˆç®—ä¸­...</div>
                        </div>
                        <div class="stat-card">
                            <h4>ä½ä¿¡å¿ƒåº¦ (â‰¤5) å‘½ä¸­ç‡</h4>
                            <div class="value" id="lowConfWinRate">--%</div>
                            <div class="sub-value" id="lowConfStats">è¨ˆç®—ä¸­...</div>
                        </div>
                        <div class="stat-card">
                            <h4>å¹³å‡å ±é…¬ç‡</h4>
                            <div class="value" id="avgReturn">--%</div>
                            <div class="sub-value" id="returnStats">è¨ˆç®—ä¸­...</div>
                        </div>
                    </div>

                    <h3 style="margin: 30px 0 15px 0;">ğŸ¯ ç­–ç•¥æ¨™ç±¤è¡¨ç¾åˆ†æ</h3>
                    <div id="strategyPerformance"></div>

                    <button class="btn-primary" onclick="runBacktest()" style="margin: 20px 0;">
                        ğŸ”„ åŸ·è¡Œå®Œæ•´å›æ¸¬(æ›´æ–°æ‰€æœ‰è¨˜éŒ„)
                    </button>
                    <div class="helper-text">
                        é»æ“Šå¾Œç³»çµ±æœƒè‡ªå‹•æª¢æŸ¥æ‰€æœ‰è¨˜éŒ„,ä¸¦æ ¹æ“šå¸‚å ´è³‡æ–™è¨ˆç®—å¯¦éš›çµæœã€‚éœ€è¦å·²ä¸Šå‚³å°æ‡‰æ—¥æœŸçš„å¸‚å ´è³‡æ–™ã€‚
                    </div>
                </div>

                <div class="filters" style="margin: 30px 0;">
                    <h3 style="margin-bottom: 15px;">ğŸ” ç¯©é¸æ¢ä»¶</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>è‚¡ç¥¨ä»£è™Ÿ</label>
                            <select id="filterStock" onchange="updateRecordsList()">
                                <option value="">å…¨éƒ¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç­–ç•¥æ¨™ç±¤</label>
                            <select id="filterTag" onchange="updateRecordsList()">
                                <option value="">å…¨éƒ¨æ¨™ç±¤</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>çµæœç‹€æ…‹</label>
                            <select id="filterOutcome" onchange="updateRecordsList()">
                                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                                <option value="win">å‹</option>
                                <option value="loss">æ•—</option>
                                <option value="holding">æŒæœ‰ä¸­</option>
                                <option value="pending">å¾…å›æ¸¬</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æœ€ä½ä¿¡å¿ƒåº¦</label>
                            <input type="number" id="filterConfidence" value="1" min="1" max="10"
                                onchange="updateRecordsList()">
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn-secondary" onclick="exportRecordsCSV()">åŒ¯å‡º CSV</button>
                        <button class="btn-primary" onclick="exportRecordsJSON()">å‚™ä»½ JSON</button>
                        <button class="btn-secondary" onclick="document.getElementById('importJsonInput').click()">
                            åŒ¯å…¥é‚„åŸ
                        </button>
                        <input type="file" id="importJsonInput" accept="application/json" style="display:none"
                            onchange="importRecordsJSON(event)">
                        <button class="btn-primary" onclick="loadFromCSV()">å¾CSVè¼‰å…¥</button>
                    </div>
                </div>

                <div id="recordsList"></div>
            </section>

        </section>
    </main>

    <footer class="app-footer">
        <p>å°è‚¡åˆ†æç³»çµ± v3.0 æ•´åˆç‰ˆ | è³‡æ–™åƒ…ä¾›åƒè€ƒ</p>
    </footer>
</div>

<script type="module">
    // ==================== å…¨åŸŸè®Šæ•¸ ====================
    const CSV_FILE_PATH = '/data/notes/records_export.csv';
    let personalRecords = [];
    let marketData = [];
    let currentTags = [];

    // ==================== åˆå§‹åŒ– ====================
    window.addEventListener('DOMContentLoaded', () => {
        // åˆå§‹åŒ–å°èˆªæŒ‰éˆ•
        initNavigation();
        
        // åˆå§‹åŒ–åˆ†æè¨˜éŒ„åŠŸèƒ½
        loadFromCSV();
        initTagsInput();
        document.getElementById('recordDate').valueAsDate = new Date();
        document.getElementById('recordForm').addEventListener('submit', addRecord);
        
        // ç”Ÿæˆæ¨¡æ“¬å¸‚å ´è³‡æ–™
        generateMockMarketData();
        
        updateRecordsList();
        updateStatistics();
    });

    // ==================== å°èˆªç³»çµ± ====================
    function initNavigation() {
        const navBtns = document.querySelectorAll('.nav-btn');
        
        navBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const viewName = btn.getAttribute('data-view');
                switchView(viewName);
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                navBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
    }

    function switchView(viewName) {
        // éš±è—æ‰€æœ‰è¦–åœ–
        document.querySelectorAll('.view-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // é¡¯ç¤ºé¸ä¸­çš„è¦–åœ–
        const viewMap = {
            'stock': 'stockView',
            'analysis': 'analysisView',
            'daily': 'dailyView',
            'compare': 'compareView',
            'record': 'recordView',
            'browse': 'browseView'
        };
        
        const targetView = document.getElementById(viewMap[viewName]);
        if (targetView) {
            targetView.classList.add('active');
            
            // å¦‚æœåˆ‡æ›åˆ°ç€è¦½çµ±è¨ˆé é¢,æ›´æ–°æ•¸æ“š
            if (viewName === 'browse') {
                updateRecordsList();
                updateStatistics();
            }
        }
    }

    // ==================== æ¨™ç±¤è¼¸å…¥ ====================
    function initTagsInput() {
        const input = document.getElementById('tagsInput');
        const container = document.getElementById('tagsContainer');

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = input.value.trim();
                if (value && !currentTags.includes(value)) {
                    currentTags.push(value);
                    renderTags();
                    input.value = '';
                }
            }
        });
    }

    function renderTags() {
        const container = document.getElementById('tagsContainer');
        const input = container.querySelector('input');
        const existingTags = container.querySelectorAll('.tag-item');
        existingTags.forEach(t => t.remove());

        currentTags.forEach(tag => {
            const tagEl = document.createElement('div');
            tagEl.className = 'tag-item';
            tagEl.innerHTML = `
                ${escapeHTML(tag)}
                <span class="remove-tag" onclick="removeTag('${escapeHTML(tag)}')">Ã—</span>
            `;
            container.insertBefore(tagEl, input);
        });
    }

    window.removeTag = function(tag) {
        currentTags = currentTags.filter(t => t !== tag);
        renderTags();
    };

    // ==================== æ–°å¢è¨˜éŒ„ ====================
    function addRecord(e) {
        e.preventDefault();

        const record = {
            date: document.getElementById('recordDate').value,
            code: document.getElementById('recordStockCode').value.trim(),
            name: document.getElementById('recordStockName').value.trim(),
            confidence: document.getElementById('recordConfidence').value,
            target: document.getElementById('recordTargetPrice').value || null,
            stop: document.getElementById('recordStopLoss').value || null,
            direction: document.getElementById('recordDirection').value,
            reason: document.getElementById('recordReason').value.trim(),
            analysis: document.getElementById('recordAnalysis').value.trim(),
            notes: document.getElementById('recordNotes').value.trim(),
            outcome: document.getElementById('recordOutcome').value,
            tags: [...currentTags],
            checkDays: document.getElementById('checkDays').value,
            actualReturn: null,
            entryPrice: null,
            exitPrice: null,
            checkedDate: null,
            createdAt: new Date().toISOString()
        };

        personalRecords.push(record);
        saveToCSV();
        
        alert('âœ… è¨˜éŒ„å·²æ–°å¢ä¸¦å„²å­˜');
        
        // é‡ç½®è¡¨å–®
        document.getElementById('recordForm').reset();
        document.getElementById('recordDate').valueAsDate = new Date();
        document.getElementById('recordConfidence').value = 5;
        document.getElementById('confidenceValue').textContent = '5';
        document.getElementById('recordOutcome').value = 'pending';
        currentTags = [];
        renderTags();
    }

    // ==================== æ›´æ–°è¨˜éŒ„åˆ—è¡¨ ====================
    function updateRecordsList() {
        const filterStock = document.getElementById('filterStock') ? document.getElementById('filterStock').value : '';
        const filterTag = document.getElementById('filterTag') ? document.getElementById('filterTag').value : '';
        const filterOutcome = document.getElementById('filterOutcome') ? document.getElementById('filterOutcome').value : '';
        const filterConfidence = document.getElementById('filterConfidence') ? parseInt(document.getElementById('filterConfidence').value) : 1;

        let filtered = personalRecords.filter(r => {
            if (filterStock && r.code !== filterStock) return false;
            if (filterTag && (!r.tags || !r.tags.includes(filterTag))) return false;
            if (filterOutcome && r.outcome !== filterOutcome) return false;
            if (r.confidence < filterConfidence) return false;
            return true;
        });

        // æ›´æ–°ç¯©é¸ä¸‹æ‹‰é¸å–®
        updateFilterOptions();

        // é¡¯ç¤ºè¨˜éŒ„
        const container = document.getElementById('recordsList');
        if (!container) return;
        
        if (filtered.length === 0) {
            container.innerHTML = '<div class="alert alert-info">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</div>';
            return;
        }

        container.innerHTML = filtered.map(r => `
            <div class="record-card">
                <h3>${r.code} ${r.name || ''} 
                    <span class="outcome-badge outcome-${r.outcome}">${getOutcomeText(r.outcome)}</span>
                </h3>
                <p><strong>æ—¥æœŸ:</strong> ${r.date} | <strong>ä¿¡å¿ƒåº¦:</strong> ${r.confidence}/10 | <strong>æ–¹å‘:</strong> ${r.direction}</p>
                ${r.target ? `<p><strong>ç›®æ¨™åƒ¹:</strong> ${r.target} | <strong>åœæåƒ¹:</strong> ${r.stop || '-'}</p>` : ''}
                <p><strong>é€²å ´ç†ç”±:</strong> ${escapeHTML(r.reason)}</p>
                ${r.analysis ? `<p><strong>æŠ€è¡“åˆ†æ:</strong> ${escapeHTML(r.analysis)}</p>` : ''}
                ${r.notes ? `<p><strong>ç­†è¨˜:</strong> ${escapeHTML(r.notes)}</p>` : ''}
                ${r.tags && r.tags.length > 0 ? `<p><strong>æ¨™ç±¤:</strong> ${r.tags.map(t => `<span class="tag-item">${escapeHTML(t)}</span>`).join(' ')}</p>` : ''}
                ${r.actualReturn !== null ? `<p><strong>å¯¦éš›å ±é…¬:</strong> ${r.actualReturn}%</p>` : ''}
                <p style="font-size: 12px; color: #999;">å»ºç«‹æ™‚é–“: ${new Date(r.createdAt).toLocaleString('zh-TW')}</p>
            </div>
        `).join('');
    }

    function updateFilterOptions() {
        // æ›´æ–°è‚¡ç¥¨ä»£è™Ÿé¸é …
        const stockSelect = document.getElementById('filterStock');
        if (stockSelect) {
            const codes = [...new Set(personalRecords.map(r => r.code))].sort();
            stockSelect.innerHTML = '<option value="">å…¨éƒ¨</option>' + 
                codes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // æ›´æ–°æ¨™ç±¤é¸é …
        const tagSelect = document.getElementById('filterTag');
        if (tagSelect) {
            const allTags = new Set();
            personalRecords.forEach(r => {
                if (r.tags) r.tags.forEach(t => allTags.add(t));
            });
            const tags = [...allTags].sort();
            tagSelect.innerHTML = '<option value="">å…¨éƒ¨æ¨™ç±¤</option>' + 
                tags.map(t => `<option value="${t}">${t}</option>`).join('');
        }
    }

    function getOutcomeText(outcome) {
        const map = {
            'win': 'å‹',
            'loss': 'æ•—',
            'holding': 'æŒæœ‰ä¸­',
            'pending': 'å¾…å›æ¸¬'
        };
        return map[outcome] || outcome;
    }

    // ==================== çµ±è¨ˆåˆ†æ ====================
    function updateStatistics() {
        const completed = personalRecords.filter(r => r.outcome === 'win' || r.outcome === 'loss');
        const wins = completed.filter(r => r.outcome === 'win').length;
        const total = completed.length;

        // ç¸½é«”å‘½ä¸­ç‡
        if (total > 0) {
            const winRate = ((wins / total) * 100).toFixed(1);
            document.getElementById('overallWinRate').textContent = `${winRate}%`;
            document.getElementById('overallStats').textContent = `${wins}å‹ ${total - wins}æ•— (å…±${total}ç­†)`;
        }

        // é«˜ä¿¡å¿ƒåº¦å‘½ä¸­ç‡
        const highConf = completed.filter(r => r.confidence >= 8);
        const highWins = highConf.filter(r => r.outcome === 'win').length;
        if (highConf.length > 0) {
            const highWinRate = ((highWins / highConf.length) * 100).toFixed(1);
            document.getElementById('highConfWinRate').textContent = `${highWinRate}%`;
            document.getElementById('highConfStats').textContent = `${highWins}å‹ ${highConf.length - highWins}æ•— (å…±${highConf.length}ç­†)`;
        }

        // ä½ä¿¡å¿ƒåº¦å‘½ä¸­ç‡
        const lowConf = completed.filter(r => r.confidence <= 5);
        const lowWins = lowConf.filter(r => r.outcome === 'win').length;
        if (lowConf.length > 0) {
            const lowWinRate = ((lowWins / lowConf.length) * 100).toFixed(1);
            document.getElementById('lowConfWinRate').textContent = `${lowWinRate}%`;
            document.getElementById('lowConfStats').textContent = `${lowWins}å‹ ${lowConf.length - lowWins}æ•— (å…±${lowConf.length}ç­†)`;
        }

        // å¹³å‡å ±é…¬ç‡
        const withReturn = personalRecords.filter(r => r.actualReturn !== null);
        if (withReturn.length > 0) {
            const avgReturn = (withReturn.reduce((sum, r) => sum + parseFloat(r.actualReturn), 0) / withReturn.length).toFixed(2);
            document.getElementById('avgReturn').textContent = `${avgReturn}%`;
            document.getElementById('returnStats').textContent = `åŸºæ–¼${withReturn.length}ç­†å·²è¨ˆç®—å ±é…¬çš„è¨˜éŒ„`;
        }

        // ç­–ç•¥æ¨™ç±¤è¡¨ç¾åˆ†æ
        updateStrategyPerformance();
    }

    function updateStrategyPerformance() {
        const tagStats = {};
        
        personalRecords.forEach(r => {
            if (!r.tags || r.tags.length === 0) return;
            
            r.tags.forEach(tag => {
                if (!tagStats[tag]) {
                    tagStats[tag] = { total: 0, wins: 0, losses: 0 };
                }
                tagStats[tag].total++;
                if (r.outcome === 'win') tagStats[tag].wins++;
                if (r.outcome === 'loss') tagStats[tag].losses++;
            });
        });

        const container = document.getElementById('strategyPerformance');
        if (!container) return;

        if (Object.keys(tagStats).length === 0) {
            container.innerHTML = '<div class="alert alert-info">å°šç„¡ç­–ç•¥æ¨™ç±¤æ•¸æ“š</div>';
            return;
        }

        const rows = Object.entries(tagStats)
            .sort((a, b) => b[1].total - a[1].total)
            .map(([tag, stats]) => {
                const winRate = stats.wins + stats.losses > 0 
                    ? ((stats.wins / (stats.wins + stats.losses)) * 100).toFixed(1) 
                    : '-';
                return `
                    <tr>
                        <td>${escapeHTML(tag)}</td>
                        <td>${stats.total}</td>
                        <td>${stats.wins}</td>
                        <td>${stats.losses}</td>
                        <td><strong>${winRate}%</strong></td>
                    </tr>
                `;
            });

        container.innerHTML = `
            <table class="strategy-table">
                <thead>
                    <tr>
                        <th>ç­–ç•¥æ¨™ç±¤</th>
                        <th>ç¸½æ•¸</th>
                        <th>å‹</th>
                        <th>æ•—</th>
                        <th>å‹ç‡</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows.join('')}
                </tbody>
            </table>
        `;
    }

    // ==================== å›æ¸¬åŠŸèƒ½ ====================
    window.runBacktest = function() {
        let updated = 0;
        
        personalRecords.forEach(record => {
            if (record.outcome !== 'pending') return;
            
            const checkDate = addBusinessDays(new Date(record.date), parseInt(record.checkDays));
            const marketRecord = findClosestMarketData(record.code, checkDate);
            
            if (marketRecord) {
                const entryData = findClosestMarketData(record.code, new Date(record.date));
                if (entryData) {
                    const entryPrice = entryData.æ”¶ç›¤åƒ¹;
                    const exitPrice = marketRecord.æ”¶ç›¤åƒ¹;
                    const returnPct = ((exitPrice - entryPrice) / entryPrice * 100).toFixed(2);
                    
                    record.entryPrice = entryPrice;
                    record.exitPrice = exitPrice;
                    record.actualReturn = returnPct;
                    record.checkedDate = formatDate(checkDate);
                    
                    // åˆ¤æ–·å‹æ•—
                    if (record.direction === 'å¤š' && returnPct > 0) {
                        record.outcome = 'win';
                    } else if (record.direction === 'ç©º' && returnPct < 0) {
                        record.outcome = 'win';
                    } else if (record.direction === '-') {
                        record.outcome = 'holding';
                    } else {
                        record.outcome = 'loss';
                    }
                    
                    updated++;
                }
            }
        });
        
        saveToCSV();
        updateRecordsList();
        updateStatistics();
        alert(`âœ… å›æ¸¬å®Œæˆ,æ›´æ–°äº† ${updated} ç­†è¨˜éŒ„`);
    };

    // ==================== CSV å„²å­˜/è¼‰å…¥ ====================
    window.saveToCSV = function() {
        const headers = [
            'date', 'code', 'name', 'confidence', 'target', 'stop',
            'direction', 'reason', 'analysis', 'notes', 'tags', 'checkDays',
            'outcome', 'actualReturn', 'entryPrice', 'exitPrice', 'checkedDate', 'createdAt'
        ];
        const rows = [headers.join(',')].concat(
            personalRecords.map(r => {
                return [
                    r.date,
                    r.code,
                    r.name,
                    r.confidence,
                    r.target || '',
                    r.stop || '',
                    quoteForCSV(r.direction),
                    quoteForCSV(r.reason),
                    quoteForCSV(r.analysis),
                    quoteForCSV(r.notes),
                    quoteForCSV(r.tags ? r.tags.join(';') : ''),
                    r.checkDays,
                    r.outcome,
                    r.actualReturn || '',
                    r.entryPrice || '',
                    r.exitPrice || '',
                    r.checkedDate || '',
                    r.createdAt
                ].join(',');
            })
        ).join('\n');

        console.log('å„²å­˜åˆ° CSV:', CSV_FILE_PATH);
        localStorage.setItem('personalRecords', JSON.stringify(personalRecords));
    }

    window.loadFromCSV = function() {
        console.log('å¾ CSV è¼‰å…¥:', CSV_FILE_PATH);
        
        const stored = localStorage.getItem('personalRecords');
        if (stored) {
            try {
                personalRecords = JSON.parse(stored);
                personalRecords = personalRecords.map(r => ({
                    ...r,
                    tags: r.tags || [],
                    checkDays: r.checkDays || 5,
                    outcome: r.outcome || 'pending',
                    direction: r.direction || '-',
                    reason: r.reason || '',
                    actualReturn: r.actualReturn || null,
                    checkedDate: r.checkedDate || null,
                    entryPrice: r.entryPrice || null,
                    exitPrice: r.exitPrice || null
                }));
                updateRecordsList();
                updateStatistics();
                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${personalRecords.length} ç­†è¨˜éŒ„`);
            } catch (e) {
                console.error('è¼‰å…¥è¨˜éŒ„å¤±æ•—:', e);
                personalRecords = [];
            }
        }
    };

    // ==================== åŒ¯å‡º/åŒ¯å…¥ ====================
    window.exportRecordsCSV = function() {
        if (personalRecords.length === 0) {
            alert('æ²’æœ‰ç´€éŒ„å¯åŒ¯å‡º');
            return;
        }
        const headers = [
            'date', 'code', 'name', 'confidence', 'target', 'stop',
            'direction', 'reason', 'analysis', 'notes', 'tags', 'checkDays',
            'outcome', 'actualReturn', 'entryPrice', 'exitPrice', 'checkedDate', 'createdAt'
        ];
        const rows = [headers.join(',')].concat(
            personalRecords.map(r => {
                return [
                    r.date,
                    r.code,
                    r.name,
                    r.confidence,
                    r.target || '',
                    r.stop || '',
                    quoteForCSV(r.direction),
                    quoteForCSV(r.reason),
                    quoteForCSV(r.analysis),
                    quoteForCSV(r.notes),
                    quoteForCSV(r.tags ? r.tags.join(';') : ''),
                    r.checkDays,
                    r.outcome,
                    r.actualReturn || '',
                    r.entryPrice || '',
                    r.exitPrice || '',
                    r.checkedDate || '',
                    r.createdAt
                ].join(',');
            })
        ).join('\n');

        downloadText('records_export.csv', rows);
    };

    window.exportRecordsJSON = function() {
        if (personalRecords.length === 0) {
            alert('æ²’æœ‰ç´€éŒ„å¯åŒ¯å‡º');
            return;
        }
        const dataStr = JSON.stringify({
            version: '3.0',
            exportedAt: new Date().toISOString(),
            records: personalRecords
        }, null, 2);
        downloadText('records_backup.json', dataStr);
    };

    window.importRecordsJSON = function(event) {
        const file = event.target.files[0];
        if (!file) {
            alert('è«‹å…ˆé¸æ“‡ JSON æª”æ¡ˆ');
            return;
        }

        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const parsed = JSON.parse(ev.target.result);
                if (parsed.records && Array.isArray(parsed.records)) {
                    personalRecords = personalRecords.concat(parsed.records);
                } else if (Array.isArray(parsed)) {
                    personalRecords = personalRecords.concat(parsed);
                } else {
                    alert('åŒ¯å…¥æ ¼å¼ä¸ç¬¦åˆé æœŸ');
                    return;
                }
                saveToCSV();
                updateRecordsList();
                updateStatistics();
                alert('âœ… åŒ¯å…¥å®Œæˆ');
            } catch (e) {
                alert('JSON è§£æå¤±æ•—:' + e.message);
            }
        };
        reader.readAsText(file, 'utf-8');
        event.target.value = '';
    };

    // ==================== å·¥å…·å‡½æ•¸ ====================
    function escapeHTML(str) {
        if (!str && str !== 0) return '';
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }

    function quoteForCSV(str) {
        if (str == null) return '';
        const s = String(str).replace(/"/g, '""');
        return `"${s}"`;
    }

    function downloadText(filename, text) {
        const blob = new Blob(['\ufeff' + text], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function addBusinessDays(date, days) {
        let count = 0;
        const result = new Date(date);

        while (count < days) {
            result.setDate(result.getDate() + 1);
            const dayOfWeek = result.getDay();
            if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                count++;
            }
        }

        return result;
    }

    function findClosestMarketData(code, targetDate) {
        const target = new Date(targetDate);
        let closest = null;
        let minDiff = Infinity;

        marketData.forEach(d => {
            if (d.ä»£ç¢¼ !== code) return;
            const dataDate = new Date(d.æ—¥æœŸ);
            const diff = Math.abs(dataDate - target);
            if (diff < minDiff && dataDate >= target) {
                minDiff = diff;
                closest = d;
            }
        });

        return closest;
    }

    function generateMockMarketData() {
        marketData = [];
        const codes = ['2330', '2317', '2454', '2881'];
        const startDate = new Date('2024-01-01');

        for (let i = 0; i < 250; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);

            if (date.getDay() === 0 || date.getDay() === 6) continue;

            codes.forEach(code => {
                const basePrice = code === '2330' ? 600 : code === '2317' ? 100 : code === '2454' ? 50 : 30;
                const randomChange = (Math.random() - 0.5) * basePrice * 0.05;
                const close = basePrice + randomChange;

                marketData.push({
                    æ—¥æœŸ: formatDate(date),
                    ä»£ç¢¼: code,
                    å•†å“: code === '2330' ? 'å°ç©é›»' : code === '2317' ? 'é´»æµ·' : code === '2454' ? 'è¯ç™¼ç§‘' : 'å¯Œé‚¦é‡‘',
                    æ”¶ç›¤åƒ¹: parseFloat(close.toFixed(2)),
                    æ¼²è·Œå¹…: parseFloat((Math.random() - 0.5) * 5).toFixed(2),
                    æˆäº¤é‡: Math.floor(Math.random() * 100000)
                });
            });
        }
    }

    // ä½¿å‡½æ•¸åœ¨å…¨åŸŸå¯ç”¨
    window.updateRecordsList = updateRecordsList;
    window.updateStatistics = updateStatistics;
</script>

</body>
</html>
